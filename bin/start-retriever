#!/usr/bin/env bash
# start-retriever

# application configuration (Production)
# export TACC_SYNC_DATA_ROOT=${TACC_SYNC_DATA_ROOT:="${CFS}/icecubed/tacc-sync"}
# export TACC_SYNC_ROOT=${TACC_SYNC_ROOT:="${HOME}/tacc-sync"}
# export TACC_SYNC_WORK_ROOT=${TACC_SYNC_WORK_ROOT:="${HOME}/tacc-sync/work"}

# application configuration (Development)
export TACC_SYNC_DATA_ROOT=${TACC_SYNC_DATA_ROOT:="/tmp/tacc/data"}
export TACC_SYNC_ROOT=${TACC_SYNC_ROOT:="${HOME}/github/tacc-sync"}
export TACC_SYNC_WORK_ROOT=${TACC_SYNC_WORK_ROOT:="/tmp/tacc/work"}

# component configuration
export INBOX_DIR=${INBOX_DIR:="${TACC_SYNC_WORK_ROOT}/hpss_queue"}
export LOG_PATH=${LOG_PATH:="${TACC_SYNC_WORK_ROOT}/log/retriever.log"}
export OUTBOX_DIR=${OUTBOX_DIR:="${TACC_SYNC_WORK_ROOT}/globus_queue"}
export PID_PATH=${PID_PATH:="${TACC_SYNC_WORK_ROOT}/semaphore/retriever.pid"}
export QUARANTINE_DIR=${QUARANTINE_DIR:="${TACC_SYNC_WORK_ROOT}/quarantine/retriever"}
export RUN_ONCE_AND_DIE=${RUN_ONCE_AND_DIE:="TRUE"}
export RUST_LOG=${RUST_LOG:="trace"}
export SEMAPHORE_DIR=${SEMAPHORE_DIR:="${TACC_SYNC_WORK_ROOT}/semaphore"}
export TRANSFER_DIR=${TRANSFER_DIR:="${TACC_SYNC_DATA_ROOT}"}
export TRANSFER_QUOTA=${TRANSFER_QUOTA:="500000000000000"}  # 500 TB
export WORK_SLEEP_SECONDS=${WORK_SLEEP_SECONDS:="3600"}  # 1 hour

# if we've already got a .pid file, then bail out
if [[ -f $PID_PATH ]]; then
    echo "Retriever component is already running: $PID_PATH"
    echo "kill -9 $(<$PID_PATH)"
    exit 1
fi

# start the Retriever component
echo "Starting Retriever component"
${TACC_SYNC_ROOT}/target/release/retriever 2>>${LOG_PATH} &

# capture the process ID of the component
echo $! >$PID_PATH
