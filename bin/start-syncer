#!/usr/bin/env bash
# start-syncer

# application configuration (Production)
# export TACC_SYNC_DATA_ROOT=${TACC_SYNC_DATA_ROOT:="/global/cfs/cdirs/icecubed"}
# export TACC_SYNC_ROOT=${TACC_SYNC_ROOT:="/global/homes/i/icecubed/tacc-sync"}
# export TACC_SYNC_WORK_ROOT=${TACC_SYNC_WORK_ROOT:="/global/homes/i/icecubed/tacc-sync/workspace"}

# application configuration (Development)
export TACC_SYNC_DATA_ROOT=${TACC_SYNC_DATA_ROOT:="/tmp/tacc/data"}
export TACC_SYNC_ROOT=${TACC_SYNC_ROOT:="${HOME}/github/tacc-sync"}
export TACC_SYNC_WORK_ROOT=${TACC_SYNC_WORK_ROOT:="/tmp/tacc/work"}

# component configuration
export HSI_BASE_PATH=${HSI_BASE_PATH:="/home/projects/icecube"}
export INBOX_DIR=${INBOX_DIR:="${TACC_SYNC_WORK_ROOT}/inbox"}
export LOG_PATH=${LOG_PATH:="${TACC_SYNC_WORK_ROOT}/log/syncer.log"}
export OUTBOX_DIR=${OUTBOX_DIR:="${TACC_SYNC_WORK_ROOT}/request_queue"}
export PID_PATH=${PID_PATH:="${TACC_SYNC_WORK_ROOT}/semaphore/syncer.pid"}
export QUARANTINE_DIR=${QUARANTINE_DIR:="${TACC_SYNC_WORK_ROOT}/quarantine/syncer"}
export RUN_ONCE_AND_DIE=${RUN_ONCE_AND_DIE:="TRUE"}
export RUST_LOG=${RUST_LOG:="trace"}
export SEMAPHORE_DIR=${SEMAPHORE_DIR:="${TACC_SYNC_WORK_ROOT}/semaphore"}
export WORK_DIR=${WORK_DIR:="${TACC_SYNC_WORK_ROOT}/hpss_queue"}
export WORK_SLEEP_SECONDS=${WORK_SLEEP_SECONDS:="3600"}  # 1 hour

# if we've already got a .pid file, then bail out
if [[ -f $PID_PATH ]]; then
    echo "Syncer component is already running: $PID_PATH"
    echo "kill -9 $(<$PID_PATH)"
    exit 1
fi

# start the Syncer component
echo "Starting Syncer component"
${TACC_SYNC_ROOT}/target/release/syncer 2>>${LOG_PATH} &

# capture the process ID of the component
echo $! >$PID_PATH
